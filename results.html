<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Results - Class Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .table-auto {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-indigo-600">Student Results</h1>
            <div class="flex items-center space-x-4">
                <span id="userName" class="font-medium text-gray-700"></span>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow">
        <h2 class="text-4xl font-extrabold text-center text-gray-900 mt-8 mb-12">
            My Academic Performance
        </h2>
        
        <div id="resultsContent" class="bg-white rounded-2xl shadow-xl p-8">
            <p id="loadingMessage" class="text-center text-gray-500">Loading your results...</p>
            
            <div id="resultsTableContainer" class="hidden overflow-x-auto">
                <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exam Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marks</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Results rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            
        </div>
    </main>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { doc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const userNameSpan = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsTableContainer = document.getElementById('resultsTableContainer');
        const resultsTableBody = document.getElementById('resultsTableBody');

        // Helper function to show a custom alert
        const showAlert = (message) => {
            alert(message);
        };
        
        // Function to fetch a document by ID from a collection
        const getDocDataById = async (collectionName, docId) => {
            try {
                const docRef = doc(db, collectionName, docId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (error) {
                console.error(`Error fetching document from ${collectionName}:`, error);
                return null;
            }
        };

        // Check user authentication and load results
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in, fetch their details
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const name = userData.name || 'User';
                    userNameSpan.textContent = name;
                    
                    // Now, fetch the student's results
                    fetchStudentResults(user.uid);
                } else {
                    showAlert('User data not found. Please log in again.');
                    signOut(auth);
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // Fetch and display student results
        const fetchStudentResults = async (studentId) => {
            try {
                const resultsQuery = query(collection(db, 'results'), where('studentId', '==', studentId));
                const resultsSnapshot = await getDocs(resultsQuery);

                loadingMessage.classList.add('hidden');
                resultsTableBody.innerHTML = '';
                
                if (resultsSnapshot.empty) {
                    resultsTableContainer.classList.add('hidden');
                    loadingMessage.textContent = 'No results found.';
                    loadingMessage.classList.remove('hidden');
                    return;
                }
                
                // Fetch all subject and exam names in parallel for efficiency
                const results = resultsSnapshot.docs.map(doc => doc.data());
                const subjectPromises = results.map(result => getDocDataById('subjects', result.subjectId));
                const examPromises = results.map(result => getDocDataById('exams', result.examId));
                
                const [subjects, exams] = await Promise.all([
                    Promise.all(subjectPromises),
                    Promise.all(examPromises)
                ]);

                // Populate the table
                results.forEach((result, index) => {
                    const subjectName = subjects[index]?.title || 'Unknown Subject';
                    const examName = exams[index]?.examName || 'Unknown Exam';
                    
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${examName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${subjectName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${result.marks}</td>
                    `;
                    resultsTableBody.appendChild(newRow);
                });
                
                resultsTableContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching student results:", error);
                loadingMessage.textContent = 'Failed to load results. Please try again later.';
                loadingMessage.classList.remove('hidden');
            }
        };

        // Add event listener for the logout button
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error);
                showAlert("An error occurred during logout. Please try again.");
            }
        });
    </script>
</body>
</html>
